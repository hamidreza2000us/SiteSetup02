#anaconda@123
#O0*vh}Ywv8Qlfz0z
#export XDG_RUNTIME_DIR="/run/user/0"
#export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"


# Generated by NetworkManager
nameserver 127.0.0.1
nameserver 1.1.1.1
options edns0 trust-ad



yum -y install wget

useradd -m hamid
#################
passwd hamid
echo "hamid   ALL=(ALL)       NOPASSWD: ALL" > /etc/sudoers.d/10-hamid
su - hamid

wget https://developers.redhat.com/content-gateway/rest/mirror/pub/openshift-v4/clients/crc/latest/crc-linux-amd64.tar.xz
tar xvf crc-linux-amd64.tar.xz 
mkdir -p ~/local/bin
mv crc-linux-*-amd64/crc ~/local/bin/
export PATH=$HOME/local/bin:$PATH
echo 'export PATH=$HOME/local/bin:$PATH' >> ~/.bashrc 
crc config set skip-check-daemon-systemd-unit true
crc config set skip-check-daemon-systemd-sockets true
crc config set consent-telemetry no

crc config set cpus 6
crc config set disable-update-check true
crc config set disk-size 110
crc config set memory 14336
crc config set nameserver 1.1.1.1
crc config set pull-secret-file ~/sec.txt


cat << EOF >> sec.txt
{"auths":{"cloud.openshift.com":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfNGQzOWJjYzAxMGI4NGQzYzkxODlkYzZmYTE1OGU3YjY6Vk1TUzBSUVhXNFM4MlE0SjlZQ1ZPU1g3WDFOVjVNRzhQRTk3TUZFMURNTTlVTDBKRE5FMVNORE1IQkJEVkxDTg==","email":"hr.moradi@futura-tec.com"},"quay.io":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfNGQzOWJjYzAxMGI4NGQzYzkxODlkYzZmYTE1OGU3YjY6Vk1TUzBSUVhXNFM4MlE0SjlZQ1ZPU1g3WDFOVjVNRzhQRTk3TUZFMURNTTlVTDBKRE5FMVNORE1IQkJEVkxDTg==","email":"hr.moradi@futura-tec.com"},"registry.connect.redhat.com":{"auth":"fHVoYy1wb29sLTMzYjM2NWU1LTMwNTQtNGI5Ni1iMDFmLTQ5MzI3NWRlMjEyZjpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSTFNelk1TXpVMk5HVTVOek0wWWpFNVlUVTVOemMyTlRRek5UUXhOR1l5WmlKOS5MeG5SeEJnVWFxTFkyeXJ1UHBGSFU2LVNWc1pJWUkxaGc3ajU5V2JXTEEyd3Jzd3R3YWNtT2hYemhtU1Q1VnRCX1gxUkhEdGZidGJDSnNXaWtzcmlBdldVWi1zTUJlR1o3VnAwU1RFbXYxTHRnVmVoTjVpblExWW1ZNlNLSmJfZVdKeHV0VHFiNVpiN1liUWwxcktrQXVaLW9nYlZOcjZ0bEZZV1FaaFNSX3l5ZUhPVWYtV3F1bkFycjl4OU5MSXdxX0hIZHlKTXY0ZUhoMUNqSm1YcUozc2Yyc0tvVVBCdkRmUXZ6Vll5MXpoZVV6bUVCZ0thd2dGcGRoX0VvTDNaZjFBN2tUUXVfNEVZelE4QmJfWVB6QUdxd0syaG9Cczk4c3JYbXY3MGJKaF9sS29LX2M4SThldVJPN1VoNUZ5cW9NeXJhbVd2MDVQOFhCOHE3RTE3TEsyUFNTaF9ZcmdUOTIxNDZsdVJKLXdTamdic2JfZG5lSFpOMzcwb1YzUlNXWENrcVBjUmlQdU9vbDVDZkpMX1pWYjNMeHNVdnJpZnFaRHJjQ0UzaHBZNE5rOWpvc2MwaXlNdG1YNmc2XzlaNC1kY1dvNGJBLTI3aUMzc0VyZ1hqbXZTemR2QzdEeWFuTU12WnZjWEFXOFZJOElpUEI0V3lFc2wtc0xSem1WTnBUeFdveElrOHZST2QtWlFvTVZkaGw1VFNzRkJnZFUyS28yUE5IRi16anNRSVlMcS0yZkxBMFJJX1ZyVnd6NElDV3VxTTlYdS1PYzVHbngxZmtfNzhyUXNhNmFBenNPQXJDS180cktqN3hodndwX0hMenBURXRGcTBTbFlHTERwVlJZeFAwbEl1LXIzallGdUVGcjBwODY5bExmTks3MDhfZzZYNHhFbWNCSQ==","email":"hr.moradi@futura-tec.com"},"registry.redhat.io":{"auth":"fHVoYy1wb29sLTMzYjM2NWU1LTMwNTQtNGI5Ni1iMDFmLTQ5MzI3NWRlMjEyZjpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSTFNelk1TXpVMk5HVTVOek0wWWpFNVlUVTVOemMyTlRRek5UUXhOR1l5WmlKOS5MeG5SeEJnVWFxTFkyeXJ1UHBGSFU2LVNWc1pJWUkxaGc3ajU5V2JXTEEyd3Jzd3R3YWNtT2hYemhtU1Q1VnRCX1gxUkhEdGZidGJDSnNXaWtzcmlBdldVWi1zTUJlR1o3VnAwU1RFbXYxTHRnVmVoTjVpblExWW1ZNlNLSmJfZVdKeHV0VHFiNVpiN1liUWwxcktrQXVaLW9nYlZOcjZ0bEZZV1FaaFNSX3l5ZUhPVWYtV3F1bkFycjl4OU5MSXdxX0hIZHlKTXY0ZUhoMUNqSm1YcUozc2Yyc0tvVVBCdkRmUXZ6Vll5MXpoZVV6bUVCZ0thd2dGcGRoX0VvTDNaZjFBN2tUUXVfNEVZelE4QmJfWVB6QUdxd0syaG9Cczk4c3JYbXY3MGJKaF9sS29LX2M4SThldVJPN1VoNUZ5cW9NeXJhbVd2MDVQOFhCOHE3RTE3TEsyUFNTaF9ZcmdUOTIxNDZsdVJKLXdTamdic2JfZG5lSFpOMzcwb1YzUlNXWENrcVBjUmlQdU9vbDVDZkpMX1pWYjNMeHNVdnJpZnFaRHJjQ0UzaHBZNE5rOWpvc2MwaXlNdG1YNmc2XzlaNC1kY1dvNGJBLTI3aUMzc0VyZ1hqbXZTemR2QzdEeWFuTU12WnZjWEFXOFZJOElpUEI0V3lFc2wtc0xSem1WTnBUeFdveElrOHZST2QtWlFvTVZkaGw1VFNzRkJnZFUyS28yUE5IRi16anNRSVlMcS0yZkxBMFJJX1ZyVnd6NElDV3VxTTlYdS1PYzVHbngxZmtfNzhyUXNhNmFBenNPQXJDS180cktqN3hodndwX0hMenBURXRGcTBTbFlHTERwVlJZeFAwbEl1LXIzallGdUVGcjBwODY5bExmTks3MDhfZzZYNHhFbWNCSQ==","email":"hr.moradi@futura-tec.com"}}}
EOF

###########
sudo echo "nameserver 127.0.0.1" >> /etc/resolv.conf
sudo echo "nameserver 1.1.1.1" >> /etc/resolv.conf

############
sudo cat << EOF >> /etc/NetworkManager/dispatcher.d/99-crc.sh
#!/bin/sh

export LC_ALL=C

systemd-resolve --interface crc --set-dns 192.168.130.11 --set-domain ~testing

exit 0
EOF



time crc setup
time crc start -c 6 -d 110 -m 14336 -p sec.txt

#for host in /sys/class/scsi_host/*; do echo "- - -" | sudo tee $host/scan; ls /dev/sd* ; done

sudo dnf -y install haproxy /usr/sbin/semanage firewalld
sudo systemctl enable --now firewalld
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --add-service=https --permanent
sudo firewall-cmd --add-service=kube-apiserver --permanent
sudo firewall-cmd --reload
sudo semanage port -a -t http_port_t -p tcp 6443
sudo cp /etc/haproxy/haproxy.cfg{,.bak}
export CRC_IP=$(crc ip)
sudo tee /etc/haproxy/haproxy.cfg &>/dev/null <<EOF
global
    log /dev/log local0

defaults
    balance roundrobin
    log global
    maxconn 100
    mode tcp
    timeout connect 5s
    timeout client 500s
    timeout server 500s

listen apps
    bind 0.0.0.0:80
    server crcvm $CRC_IP:80 check

listen apps_ssl
    bind 0.0.0.0:443
    server crcvm $CRC_IP:443 check

listen api
    bind 0.0.0.0:6443
    server crcvm $CRC_IP:6443 check
EOF

sudo systemctl restart haproxy
sudo systemctl status haproxy








oc login -u kubeadmin -p h4eDc-Ja2t7-9vzfF-ayJe3 https://api.crc.testing:6443

-----------------

oc login --token=sha256~ogjHwash36_vBWCFThFetGO2pPWjZF0pPBxQ4wpGjQk --server=https://api.crc.testing:6443


The server is accessible via web console at:
  https://console-openshift-console.apps-crc.testing

Log in as administrator:
  Username: kubeadmin
  Password: 7mC6u-Su9qq-XUFdN-Z4gzJ

Log in as user:
  Username: developer
  Password: developer

Use the 'oc' command line interface:
eval $(crc oc-env)
oc login -u developer https://api.crc.testing:6443

real    4m53.685s
user    0m0.784s
sys     0m0.227s


The server is accessible via web console at:
  https://console-openshift-console.apps-crc.testing

Log in as administrator:
  Username: kubeadmin
  Password: mVgT4-IdEs3-YFvAX-ZGFnG

Log in as user:
  Username: developer
  Password: developer

Nnj83-PIoDi-4E43i-ojSWA

 oc --kubeconfig=/home/hamid/.crc/machines/crc/kubeconfig whoami
 
 nneAx-kDy4b-sTB7n-homFH